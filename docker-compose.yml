version: '3.8'

services:
  # Agent service - Backend WebSocket server with PTY and file operations
  agent:
    build:
      context: .
      dockerfile: packages/agent/Dockerfile
    container_name: vibepilot-agent
    ports:
      - "9800:9800"
    environment:
      - PORT=9800
      - NODE_ENV=production
      - SESSION_TIMEOUT=300
      - SIGNALING_URL=ws://signaling:9900
    volumes:
      # Mount workspace directory for file operations
      - ./workspace:/workspace:rw
    restart: unless-stopped
    networks:
      - vibepilot-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9800', (r) => process.exit(r.statusCode === 426 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Signaling server - WebRTC signaling relay
  signaling:
    build:
      context: .
      dockerfile: signaling-server/Dockerfile
    container_name: vibepilot-signaling
    ports:
      - "9900:9900"
    environment:
      - PORT=9900
      - NODE_ENV=production
    restart: unless-stopped
    networks:
      - vibepilot-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9900', (r) => process.exit(r.statusCode === 426 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Web frontend - Next.js application
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: vibepilot-web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - NEXT_PUBLIC_WS_URL=ws://localhost:9800
      - NEXT_PUBLIC_SIGNALING_URL=ws://localhost:9900
    depends_on:
      agent:
        condition: service_healthy
      signaling:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - vibepilot-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  vibepilot-network:
    driver: bridge

volumes:
  workspace:
    driver: local
